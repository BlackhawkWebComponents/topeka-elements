<!--
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../core-ajax/core-ajax.html">
<link rel="import" href="../firebase-element/firebase-element.html">
<link rel="import" href="../firebase-element/firebase-login.html">

<polymer-element name="topeka-datasource" noscript hidden>
<template>
  
  <firebase-login id="fbLogin" provider="anonymous" params='{"rememberMe": true}' location="https://polymer-topeka.firebaseio.com" user="{{fbUser}}" statusKnown="{{statusKnown}}"></firebase-login>
  <firebase-element id="fbUser" location="{{!offline && fbUser ? 'https://polymer-topeka.firebaseio.com/users/' + fbUser.uid : null}}" priority="{{user.score}}" data="{{user}}" dataReady="{{connected}}"></firebase-element>
  <core-ajax auto handleAs="json" url="{{url}}" response="{{categories}}"></core-ajax>

</template>
<script>

  Polymer('topeka-datasource', {

    publish: {
      user: null,
      categories: null,
      url: null,
      connected: false
    },

    ready: function() {
      this.test = window.location.search.indexOf('test') >= 0;
      this.offline = this.test || window.location.search.indexOf('offline') >= 0;
      if (this.test) {
        this.user = {
          name: "Test U",
          avatar: 1,
          score: 0
        };
      }
    },
    statusKnownChanged: function() {
      if (this.statusKnown && !this.offline && !this.fbUser) {
        this.$.fbLogin.login();
      }
    },
    userChanged: function() {
      if (!this.user) {
        this.logout();
      }
    },
    logout: function() {
      this.$.fbLogin.logout();
      this.$.fbLogin.login();
    }
  });

</script>
</polymer-element>
